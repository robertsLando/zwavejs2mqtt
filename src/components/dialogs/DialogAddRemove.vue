<template>
	<v-dialog v-model="value" @click:outside="$emit('close')" max-width="800px">
		<v-card :loading="loading">
			<v-card-title>
				<span class="headline">Nodes Manager</span>
			</v-card-title>

			<v-card-text>
				<v-stepper v-model="currentStep" @change="changeStep">
					<v-stepper-header>
						<template v-for="s in steps">
							<v-stepper-step
								:key="`${s.key}-step`"
								:complete="currentStep > s.index"
								:step="s.index"
								:editable="
									!['s2Classes', 's2Pin'].includes(s.key)
								"
							>
								{{ s.title }}
							</v-stepper-step>

							<v-divider
								v-if="s.index !== steps.length"
								:key="s.index"
							></v-divider>
						</template>
					</v-stepper-header>

					<v-stepper-items>
						<v-stepper-content
							v-for="s in steps"
							:key="`${s.key}-content`"
							:step="s.index"
						>
							<v-card elevation="0">
								<v-card-text v-if="s.key == 'action'">
									<v-radio-group
										v-model="s.values.action"
										mandatory
									>
										<v-radio :value="0">
											<template v-slot:label>
												<div class="option">
													<v-icon
														color="green accent-4"
														small
														>add_circle</v-icon
													>
													<strong>Inclusion</strong>
													<small
														>Add a new device to the
														network</small
													>
												</div>
											</template>
										</v-radio>
										<v-radio :value="1">
											<template v-slot:label>
												<div class="option">
													<v-icon
														color="amber accent-4"
														small
														>autorenew</v-icon
													>
													<strong>Replace</strong>
													<small
														>Replace a failed
														device</small
													>
												</div>
											</template>
										</v-radio>
										<v-radio :value="2">
											<template v-slot:label>
												<div class="option">
													<v-icon
														color="red accent-4"
														small
														>remove_circle</v-icon
													>
													<strong>Exclusion</strong>
													<small
														>Remove device from
														network</small
													>
												</div>
											</template>
										</v-radio>
									</v-radio-group>

									<v-card-actions>
										<v-btn
											color="primary"
											@click="nextStep"
										>
											Next
										</v-btn>

										<v-btn
											v-if="state !== 'wait'"
											text
											@click="stopAction"
										>
											Stop
										</v-btn>
									</v-card-actions>
								</v-card-text>
								<v-card-text v-if="s.key == 'replaceFailed'">
									<v-combobox
										label="Node"
										v-model="s.values.replaceId"
										:items="nodes"
										return-object
										chips
										hint="Failed node to remove. Write the node Id and press enter if not present"
										persistent-hint
										item-text="_name"
									></v-combobox>
									<v-card-actions>
										<v-btn
											color="primary"
											@click="nextStep"
										>
											Next
										</v-btn>
									</v-card-actions>
								</v-card-text>

								<v-card-text v-if="s.key == 'inclusionMode'">
									<v-radio-group
										v-model="s.values.inclusionMode"
										mandatory
									>
										<v-radio :value="0">
											<template v-slot:label>
												<div class="option">
													<v-icon
														color="green accent-4"
														small
														>add_circle</v-icon
													>
													<strong>Default</strong>
													<small
														>S2 when supported, S0
														only when necessary, no
														encryption otherwise.
														Requires user
														interaction</small
													>
												</div>
											</template>
										</v-radio>
										<v-radio disabled :value="1">
											<template v-slot:label>
												<div class="option">
													<v-icon
														color="primary"
														small
														>smart_button</v-icon
													>
													<strong
														>Smart start (COMING
														SOON)</strong
													>
													<small
														>S2 only. Allows
														pre-configuring the
														device inclusion
														settings, which will
														then happen without user
														interaction</small
													>
												</div>
											</template>
										</v-radio>
										<v-radio :value="2">
											<template v-slot:label>
												<div class="option">
													<v-icon
														color="amber accent-4"
														small
														>no_encryption</v-icon
													>
													<strong
														>No encryption</strong
													>
													<small
														>Do not use
														encryption</small
													>
												</div>
											</template>
										</v-radio>
									</v-radio-group>

									<v-card-actions>
										<v-btn
											color="primary"
											@click="nextStep"
										>
											Next
										</v-btn>
										<v-btn
											v-if="state !== 'wait'"
											text
											@click="stopAction"
										>
											Stop
										</v-btn>
									</v-card-actions>
								</v-card-text>

								<v-card-text v-if="s.key == 's2Classes'">
									<v-checkbox
										:disabled="
											s.values.accessControl === undefined
										"
										v-model="s.values.accessControl"
										label="S2 Access Control"
										hint="Example: Door Locks, garage doors"
										persistent-hint
									></v-checkbox>
									<v-checkbox
										:disabled="s.values.auth === undefined"
										v-model="s.values.auth"
										label="S2 Authenticated"
										hint="Example: Lightning, Sensors, Security Systems"
										persistent-hint
									></v-checkbox>
									<v-checkbox
										:disabled="
											s.values.unAuth === undefined
										"
										v-model="s.values.unAuth"
										label="S2 Unauthenticated"
										hint="Like S2 Authenticated but without verificationt that the correct device is included"
										persistent-hint
									></v-checkbox>
									<v-checkbox
										:disabled="
											s.values.legacy === undefined
										"
										v-model="s.values.legacy"
										label="S0 legacy"
										hint="Example: Legacy door locks without S2 support"
										persistent-hint
									></v-checkbox>
									<v-checkbox
										:disabled="
											s.values.clientAuth === undefined
										"
										v-model="s.values.clientAuth"
										label="Client-side authentication"
										hint="Authentication of the inclusion happens on the device instead of on the controller (for devices without DSK)"
										persistent-hint
									></v-checkbox>

									<v-card-actions v-if="!loading">
										<v-btn
											v-if="!aborted"
											color="primary"
											@click="nextStep"
										>
											Next
										</v-btn>

										<v-btn
											color="error"
											@click="abortInclusion"
										>
											Abort
										</v-btn>
									</v-card-actions>
								</v-card-text>
								<v-card-text v-if="s.key == 's2Pin'">
									<v-text-field
										label="DSK Pin"
										persistent-hint
										hint="Enter the 5-digit PIN for your device and verify that the rest of digits matches the one that can be found on your device manual"
										v-model.trim="s.values.pin"
										:suffix="s.suffix"
									>
									</v-text-field>

									<v-card-actions v-if="!loading">
										<v-btn
											v-if="!aborted"
											color="primary"
											@click="nextStep"
										>
											Next
										</v-btn>

										<v-btn
											color="error"
											@click="abortInclusion"
										>
											Abort
										</v-btn>
									</v-card-actions>
								</v-card-text>

								<v-card-text v-if="s.key == 'done'">
									<v-col
										class="d-flex flex-column align-center"
									>
										<v-icon
											size="60"
											:color="
												s.success
													? 'success'
													: 'warning'
											"
											>{{
												s.success
													? 'check_circle'
													: 'warning'
											}}</v-icon
										>
										<p class="mt-3 headline">
											{{ s.text }}
										</p>
									</v-col>
								</v-card-text>
							</v-card>
						</v-stepper-content>
					</v-stepper-items>
				</v-stepper>

				<v-alert
					class="mt-3"
					v-if="alert"
					dense
					text
					:type="alert.type"
					>{{ alert.text }}</v-alert
				>
			</v-card-text>
		</v-card>
	</v-dialog>
</template>

<script>
import { mapGetters } from 'vuex'
import { socketEvents } from '@/plugins/socket'

export default {
	props: {
		value: Boolean, // show or hide
		socket: Object,
	},
	data() {
		return {
			currentStep: 1,
			loading: false,
			availableSteps: {
				action: {
					key: 'action',
					title: 'Action',
					values: {
						action: 0, //inclusion
					},
				},
				inclusionMode: {
					key: 'inclusionMode',
					title: 'Inclusion Mode',
					values: {
						inclusionMode: 0, //default, smartstart no encryption
					},
				},
				s2Classes: {
					key: 's2Classes',
					title: 'Security Classes',
					values: {
						accessControl: false,
						auth: false,
						unAuth: false,
						legacy: false,
						clientAuth: false,
					},
				},
				s2Pin: {
					key: 's2Pin',
					title: 'DSK validation',
					suffix: '',
					values: {
						pin: '',
					},
				},
				replaceFailed: {
					key: 'replaceFailed',
					title: 'Node Id',
					values: {
						replaceId: null, //default
					},
				},
				done: {
					key: 'done',
					success: false,
					title: 'Done',
					text: 'Test',
				},
			},
			steps: [],
			state: 'new',
			commandEndDate: new Date(),
			commandTimer: null,
			waitTimeout: null,
			alert: null,
			nodeFound: null,
			currentAction: null,
			bindedSocketEvents: {},
			stopped: false,
			aborted: false,
		}
	},
	computed: {
		...mapGetters(['appInfo', 'zwave', 'nodes']),
		timeoutMs() {
			return this.zwave.commandsTimeout * 1000 + 800 // add small buffer
		},
		controllerStatus() {
			return this.appInfo.controllerStatus
		},
	},
	mounted() {
		this.init()
		this.bindEvent(
			'grantSecurityClasses',
			this.onGrantSecurityCC.bind(this)
		)
		this.bindEvent('validateDSK', this.onValidateDSK.bind(this))
		this.bindEvent('nodeRemoved', this.onNodeRemoved.bind(this))
		this.bindEvent('nodeAdded', this.onNodeAdded.bind(this))
	},
	watch: {
		value() {
			this.init()
		},
		commandEndDate(newVal) {
			if (this.commandTimer) {
				clearInterval(this.commandTimer)
			}
			this.commandTimer = setInterval(() => {
				const now = new Date()
				const s = Math.trunc((this.commandEndDate - now) / 1000)
				if (this.state === 'start') {
					this.alert = {
						type: 'info',
						text: `${this.currentAction} started: ${s}s remaining`,
					}
				}
				if (now > newVal) clearInterval(this.commandTimer)
			}, 100)
		},
		controllerStatus(status) {
			if (status && status.indexOf('clusion') > 0) {
				if (this.state === 'new') return // ignore initial status

				// inclusion/exclusion started, start the countdown timer
				if (status.indexOf('started') > 0) {
					this.commandEndDate = new Date(
						new Date().getTime() + this.timeoutMs
					)
					this.nodeFound = null
					this.state = 'start'
				} else if (status.indexOf('stopped') > 0) {
					// inclusion/exclusion stopped, check what happened
					this.commandEndDate = new Date()
					this.alert = {
						type: 'info',
						text: `${this.currentAction} stopped, waiting for changes…`,
					}
					this.state = 'wait'
					let timeout = this.currentAction === 'Exclusion' ? 2000 : 0
					if (this.stopped) {
						timeout = 1000
						this.stopped = false
					}

					if (timeout > 0) {
						// don't use a timeout for inclusion
						this.waitTimeout = setTimeout(this.showResults, timeout) // add additional discovery time
					}
				} else {
					// error
					this.commandEndDate = new Date()
					this.alert = {
						type: 'error',
						text: status, // TODO: better formatting?
					}
					this.state = 'stop'
				}
			}
		},
	},
	methods: {
		copy(o) {
			return JSON.parse(JSON.stringify(o))
		},
		onNodeAdded({ node, result }) {
			this.nodeFound = node

			// the add/remove dialog is waiting for a feedback
			if (this.waitTimeout) {
				this.showResults(result)
			}
		},
		onNodeRemoved(node) {
			this.nodeFound = node

			// the add/remove dialog is waiting for a feedback
			if (this.waitTimeout) {
				this.showResults()
			}
		},
		changeStep(index) {
			this.steps = this.steps.slice(0, index)
		},
		abortInclusion() {
			this.aborted = true
			this.$emit('apiRequest', 'abortInclusion', [])
		},
		onGrantSecurityCC(requested) {
			const grantStep = this.availableSteps.s2Classes
			const classes = requested.securityClasses
			const values = grantStep.values
			values.accessControl = classes.includes(2) || undefined
			values.auth = classes.includes(1) || undefined
			values.unAuth = classes.includes(0) || undefined
			values.legacy = classes.includes(7) || undefined

			values.clientAuth = requested.clientSideAuth || undefined

			this.loading = false

			this.pushStep(grantStep)
		},
		onValidateDSK(dsk) {
			const dskStep = this.availableSteps.s2Pin
			dskStep.suffix = dsk

			this.loading = false
			this.pushStep(dskStep)
		},
		nextStep() {
			const s = this.steps[this.currentStep - 1]
			if (s.key === 'action') {
				const mode = s.values.action

				if (mode === 0) {
					// inclusion
					this.currentAction = 'Inclusion'
					this.pushStep('inclusionMode')
				} else if (mode === 1) {
					// replace
					this.currentAction = 'Inclusion'
					this.pushStep('replaceFailed')
				} else if (mode === 2) {
					// exclusion
					this.currentAction = 'Exclusion'
					this.sendAction('startExclusion', [])
				}
			} else if (s.key === 'inclusionMode') {
				const mode = s.values.inclusionMode
				this.aborted = false
				const replaceStep = this.steps.find(
					(s) => s.key === 'replaceFailed'
				)
				if (replaceStep) {
					let replaceId = replaceStep.values.replaceId
					if (typeof replaceId === 'object') {
						replaceId = replaceId.id
					} else {
						replaceId = parseInt(replaceId, 10)
					}
					this.sendAction('replaceFailedNode', [replaceId, mode])
				} else {
					this.sendAction('startInclusion', [mode])
				}
			} else if (s.key === 's2Classes') {
				const values = s.values

				const securityClasses = []

				if (values.accessControl) {
					securityClasses.push(2)
				}

				if (values.auth) {
					securityClasses.push(1)
				}

				if (values.unAuth) {
					securityClasses.push(0)
				}

				if (values.legacy) {
					securityClasses.push(7)
				}

				this.$emit('apiRequest', 'grantSecurityClasses', [
					{
						securityClasses,
						clientSideAuth: !!values.clientAuth,
					},
				])

				this.loading = true
			} else if (s.key === 's2Pin') {
				const mode = s.values.pin
				this.$emit('apiRequest', 'validateDSK', [mode])
				this.loading = true
			} else if (s.key === 'replaceFailed') {
				this.currentAction = 'Inclusion'
				this.pushStep('inclusionMode')
			}
		},
		init() {
			this.steps = []
			this.pushStep('action')

			this.currentAction = null
			this.loading = false
			this.alert = null
			this.nodeFound = null
			this.stopped = false
			this.aborted = false

			if (this.waitTimeout) {
				clearTimeout(this.waitTimeout)
				this.waitTimeout = null
			}
		},
		async pushStep(step) {
			const s =
				typeof step === 'string' ? this.availableSteps[step] : step
			s.index = this.steps.length + 1
			this.steps.push(this.copy(s))
			await this.$nextTick()
			this.currentStep = s.index
		},
		stopAction() {
			this.stopped = true
			this.sendAction('stop' + this.currentAction)
		},
		sendAction(api, args) {
			this.commandEndDate = new Date()
			this.alert = {
				type: 'info',
				text: `${this.currentAction} ${
					this.method === 'start' ? 'starting…' : 'stopping…'
				}`,
			}

			this.$emit('apiRequest', api, args)
			this.state = 'wait' // make sure user can't trigger another action too soon
		},
		bindEvent(eventName, handler) {
			this.socket.on(socketEvents[eventName], handler)
			this.bindedSocketEvents[eventName] = handler
		},
		unbindEvents() {
			for (const event in this.bindedSocketEvents) {
				this.socket.off(event, this.bindedSocketEvents[event])
			}
		},
		showResults(result) {
			if (this.waitTimeout) {
				clearTimeout(this.waitTimeout)
				this.waitTimeout = null
			}

			if (this.nodeFound === null) {
				this.alert = {
					type: 'warning',
					text: `${this.currentAction} stopped, no changes detected`,
				}
			} else if (this.currentAction === 'Exclusion') {
				this.alert = null
				this.aborted = false
				const doneStep = this.copy(this.availableSteps.done)
				doneStep.text = `Node ${this.nodeFound.id} removed`
				doneStep.success = true
				this.pushStep(doneStep)
			} else {
				this.alert = null
				this.aborted = false
				const doneStep = this.copy(this.availableSteps.done)
				doneStep.text = `Device found! Node ${this.nodeFound.id} added with security "${this.nodeFound.security}"`
				doneStep.success = !(result && result.lowSecurity)
				this.pushStep(doneStep)
			}

			this.loading = false

			this.state = 'stop'
		},
	},
	beforeDestroy() {
		if (this.commandTimer) {
			clearInterval(this.commandTimer)
		}

		if (this.waitTimeout) {
			clearTimeout(this.waitTimeout)
		}

		this.unbindEvents()

		this.alert = null
	},
}
</script>

<style scoped>
.option {
	margin-top: 1rem;
}
.option > small {
	color: #888;
	display: block;
	margin: -0.2rem 0 0 1.4rem;
}
</style>
